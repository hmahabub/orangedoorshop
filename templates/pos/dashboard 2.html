<!DOCTYPE html>
<html>
<head>
    <title>POS - Door Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .pos-container { display: flex; height: 100vh;  }
        .products-section { flex: 3; padding: 20px; overflow-y: auto; background: #f8f9fa; }
        .cart-section { flex: 2; background: white; padding: 20px; border-left: 1px solid #dee2e6; }
        .product-card { 
            cursor: pointer; 
            margin-bottom: 10px; 
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }
        .product-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-color: #007bff;
        }
        .cart-item { border-bottom: 1px solid #dee2e6; padding: 10px 0; }
        .low-stock { background-color: #fff3cd; }
        .out-of-stock { background-color: #f8d7da; opacity: 0.6; }
        .category-badge { font-size: 0.7rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                üö™ Door Shop POS
            </a>
            <div class="navbar-nav ms-auto">
                <a href="{% url 'dashboard' %}" class="nav-link">Main Dashboard</a>
                <a href="{% url 'inventory_dashboard' %}" class="nav-link">Inventory</a>
                <a href="{% url 'admin:logout' %}" class="nav-link">Logout</a>
            </div>
        </div>
    </nav>

    <div class="pos-container">
        <!-- Products Section -->
        <div class="products-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Products</h3>
                <div class="d-flex gap-2">
                    <input type="text" id="productSearch" class="form-control" placeholder="Search products..." style="width: 300px;">
                    <select id="categoryFilter" class="form-select" style="width: 200px;">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="row" id="productsGrid">
                {% for product in products %}
                <div class="col-md-3 mb-3 product-item" 
                     data-category="{{ product.category.id }}"
                     data-name="{{ product.name|lower }}">
                    <div class="card product-card 
                        {% if product.track_stock and product.current_stock <= 0 %}out-of-stock
                        {% elif product.track_stock and product.current_stock <= product.min_stock_level %}low-stock
                        {% endif %}"
                        onclick="addToCart({{ product.id }})">
                        <div class="card-body">
                            <h6 class="card-title">{{ product.name }}</h6>
                            <span class="badge bg-secondary category-badge">{{ product.category.name }}</span>
                            <p class="card-text mb-1">
                                <strong>${{ product.selling_price }}</strong>
                            </p>
                            {% if product.track_stock %}
                                {% if product.current_stock <= 0 %}
                                    <small class="text-danger">Out of Stock</small>
                                {% else %}
                                    <small class="text-muted">Stock: {{ product.current_stock }}</small>
                                {% endif %}
                            {% else %}
                                <small class="text-success">In Stock</small>
                            {% endif %}
                            {% if product.width and product.height %}
                                <br><small class="text-info">{{ product.width }}" x {{ product.height }}"</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Cart Section -->
        <div class="cart-section">
            <h3>Current Sale</h3>
            

            <!-- Customer Search & Selection -->
            <div class="mb-3">
                <label class="form-label">Customer Search</label>
                <div class="input-group mb-2">
                    <input type="text" id="customerPhone" class="form-control" placeholder="Enter mobile number..." maxlength="15">
                    <button class="btn btn-outline-primary" type="button" onclick="searchCustomerByPhone()">
                        üîç Search
                    </button>
                </div>
                <div class="form-text">
                    Enter mobile number to search existing customer or create new one automatically.
                </div>
            </div>

            <!-- Customer Details (Initially Hidden) -->
            <div id="customerDetails" class="card mb-3" style="display: none;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">Customer Information</h6>
                        <button type="button" class="btn-close" onclick="clearCustomer()"></button>
                    </div>
                    <div id="customerInfo">
                        <!-- Customer details will be populated here -->
                    </div>
                    <input type="hidden" id="selectedCustomerId" name="customer_id">
                </div>
            </div>

            <!-- New Customer Form (Initially Hidden) -->
            <div id="newCustomerForm" class="card mb-3" style="display: none;">
                <div class="card-body">
                    <h6 class="card-title">Create New Customer</h6>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label">Name *</label>
                            <input type="text" id="newCustomerName" class="form-control" placeholder="Customer name">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Mobile *</label>
                            <input type="text" id="newCustomerPhone" class="form-control" readonly>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Email</label>
                            <input type="email" id="newCustomerEmail" class="form-control" placeholder="Email address">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Address</label>
                            <textarea id="newCustomerAddress" class="form-control" rows="2" placeholder="Address"></textarea>
                        </div>
                        <div class="col-md-12">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-2">
                                <button type="button" class="btn btn-secondary me-md-2" onclick="cancelNewCustomer()">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="createNewCustomer()">Create Customer</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cart Items -->
            <div class="cart-items mb-3">
                <div id="cartItems" style="max-height: 300px; overflow-y: auto;">
                    <!-- Cart items will be added here dynamically -->
                    <div class="text-muted text-center p-3" id="emptyCartMessage">
                        No items in cart. Click on products to add them.
                    </div>
                </div>
            </div>

            <!-- Totals -->
            <div class="totals-section mb-3">
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span id="subtotal">$0.00</span>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Discount:</span>
                    <div class="input-group input-group-sm" style="width: 150px;">
                        <input type="number" id="discountAmount" class="form-control" value="0" min="0" step="0.01">
                        <span class="input-group-text">$</span>
                    </div>
                </div>

                <div class="d-flex justify-content-between mb-2">
                    <span>Tax:</span>
                    <span id="taxAmount">$0.00</span>
                </div>

                <hr>
                <div class="d-flex justify-content-between mb-3">
                    <strong>Total:</strong>
                    <strong id="grandTotal">$0.00</strong>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="mb-3">
                <label class="form-label">Payment Method</label>
                <select class="form-select" id="paymentMethod">
                    <option value="cash">Cash</option>
                    <option value="card">Card</option>
                    <option value="mobile">Mobile Banking</option>
                    <option value="due">Customer Due</option>
                </select>
            </div>

            <!-- Amount Received -->
            <div class="mb-3" id="paymentReceivedSection">
                <label class="form-label">Amount Received</label>
                <input type="number" id="paymentReceived" class="form-control" value="0" step="0.01" min="0">
            </div>

            <!-- Change -->
            <div class="d-flex justify-content-between mb-3">
                <strong>Change:</strong>
                <strong id="changeAmount">$0.00</strong>
            </div>

            <!-- Notes -->
            <div class="mb-3">
                <label class="form-label">Notes (Optional)</label>
                <textarea class="form-control" id="saleNotes" rows="2"></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2">
                <button class="btn btn-success btn-lg" onclick="processSale()">
                    üí≥ Complete Sale
                </button>
                <button class="btn btn-outline-danger" onclick="clearCart()">
                    üóëÔ∏è Clear Cart
                </button>
            </div>
        </div>
    </div>

    <!-- New Customer Modal -->
    <div class="modal fade" id="newCustomerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newCustomerForm">
                        <div class="mb-3">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-control" id="customerName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="customerEmail">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" id="customerAddress" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewCustomer()">Save Customer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let cart = [];
        
        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Search functionality
            document.getElementById('productSearch').addEventListener('input', filterProducts);
            document.getElementById('categoryFilter').addEventListener('change', filterProducts);
            
            // Payment method change
            document.getElementById('paymentMethod').addEventListener('change', function() {
                const isDue = this.value === 'due';
                document.getElementById('paymentReceivedSection').style.display = isDue ? 'none' : 'block';
                calculateChange();
            });
            
            // Real-time calculations
            document.getElementById('discountAmount').addEventListener('input', updateCartDisplay);
            document.getElementById('paymentReceived').addEventListener('input', calculateChange);
        });
        

        async function addToCart(productId) {
            const response = await fetch(`/pos/api/product/${productId}/`);
            const product = await response.json();
            
            // Check stock availability
            if (product.track_stock && parseFloat(product.current_stock) <= 0) {
                alert('This product is out of stock!');
                return;
            }
            
            const existingItem = cart.find(item => item.product_id === productId);
            if (existingItem) {
                const newQuantity = parseFloat(existingItem.quantity) + 1;
                if (product.track_stock && newQuantity > parseFloat(product.current_stock)) {
                    alert(`Only ${product.current_stock} units available in stock!`);
                    return;
                }
                existingItem.quantity = newQuantity.toString();
            } else {
                cart.push({
                    product_id: productId,
                    name: product.name,
                    quantity: '1',
                    unit_price: product.selling_price,
                    track_stock: product.track_stock,
                    current_stock: product.current_stock
                });
            }
            
            updateCartDisplay();
        }

function updateQuantity(index, newQuantity) {
    // Convert to number for validation
    const qty = parseFloat(newQuantity);
    
    // Validate quantity
    if (isNaN(qty) || qty < 1) {
        removeFromCart(index);
        return;
    }
    
    const item = cart[index];
    
    // Check stock availability
    if (item.track_stock && qty > parseFloat(item.current_stock)) {
        alert(`Only ${item.current_stock} units available in stock!`);
        return;
    }
    
    // Update quantity as string to maintain consistency
    cart[index].quantity = qty.toString();
    updateCartDisplay();
}

// Also update the cart item HTML generation in updateCartDisplay function
// Replace the quantity input section with this:

function updateCartDisplay() {
    const cartItems = document.getElementById('cartItems');
    const emptyCartMessage = document.getElementById('emptyCartMessage');
    const subtotalElement = document.getElementById('subtotal');
    const grandTotalElement = document.getElementById('grandTotal');
    
    cartItems.innerHTML = '';
    let subtotal = 0;
    
    if (cart.length === 0) {
        emptyCartMessage.style.display = 'block';
        subtotalElement.textContent = '$0.00';
        grandTotalElement.textContent = '$0.00';
        calculateChange();
        return;
    }
    
    emptyCartMessage.style.display = 'none';
    
    cart.forEach((item, index) => {
        const quantity = parseFloat(item.quantity);
        const unitPrice = parseFloat(item.unit_price);
        const itemTotal = quantity * unitPrice;
        subtotal += itemTotal;
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        itemDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div style="flex: 1;">
                    <strong>${item.name}</strong><br>
                    <small>$${unitPrice.toFixed(2)} each</small>
                </div>
                <div class="text-end">
                    <div class="input-group input-group-sm mb-1" style="width: 120px;">
                        <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${index}, ${quantity - 1})">-</button>
                        <input type="number" class="form-control text-center" value="${quantity}" 
                               onchange="updateQuantity(${index}, parseFloat(this.value))" 
                               min="1" step="1" ${item.track_stock ? `max="${item.current_stock}"` : ''}>
                        <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${index}, ${quantity + 1})">+</button>
                    </div>
                    <div>
                        <strong>$${itemTotal.toFixed(2)}</strong>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeFromCart(${index})">√ó</button>
                    </div>
                </div>
            </div>
        `;
        cartItems.appendChild(itemDiv);
    });
    
    const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
    const tax = subtotal * 0.1; // 10% tax - adjust as needed
    const grandTotal = Math.max(0, subtotal - discount + tax);
    
    subtotalElement.textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('taxAmount').textContent = `$${tax.toFixed(2)}`;
    grandTotalElement.textContent = `$${grandTotal.toFixed(2)}`;
    calculateChange();
}
        function calculateChange() {
            const paymentMethod = document.getElementById('paymentMethod').value;
            const paymentReceived = parseFloat(document.getElementById('paymentReceived').value) || 0;
            const grandTotal = parseFloat(document.getElementById('grandTotal').textContent.replace('$', '')) || 0;
            
            if (paymentMethod !== 'due') {
                const change = Math.max(0, paymentReceived - grandTotal);
                document.getElementById('changeAmount').textContent = `$${change.toFixed(2)}`;
            } else {
                document.getElementById('changeAmount').textContent = '$0.00';
            }
        }

        function clearCart() {
            if (cart.length === 0) return;
            if (confirm('Are you sure you want to clear the cart?')) {
                cart = [];
                updateCartDisplay();
            }
        }

        function addNewCustomer() {
            new bootstrap.Modal(document.getElementById('newCustomerModal')).show();
        }

        async function saveNewCustomer() {
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            const email = document.getElementById('customerEmail').value;
            const address = document.getElementById('customerAddress').value;
            
            if (!name) {
                alert('Customer name is required!');
                return;
            }
            
            try {
                const response = await fetch('/inventory/customers/add/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}&email=${encodeURIComponent(email)}&address=${encodeURIComponent(address)}`
                });
                
                if (response.ok) {
                    // Reload the page to get updated customer list
                    location.reload();
                } else {
                    alert('Error saving customer');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function processSale() {
            if (cart.length === 0) {
                alert('Please add items to cart');
                return;
            }

            const saleData = {
                customer_id: document.getElementById('customerSelect').value,
                discount_amount: document.getElementById('discountAmount').value,
                payment_method: document.getElementById('paymentMethod').value,
                payment_received: document.getElementById('paymentReceived').value,
                notes: document.getElementById('saleNotes').value,
                items: cart.map(item => ({
                    product_id: item.product_id,
                    quantity: item.quantity,
                    unit_price: item.unit_price
                }))
            };

            try {
                const response = await fetch('/pos/api/create-sale/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(saleData)
                });

                const result = await response.json();
                
                if (result.success) {
                    // Open receipt in new window
                    const receiptWindow = window.open(`/pos/receipt/${result.sale_id}/`, '_blank');
                    
                    // Clear cart and reset form
                    cart = [];
                    updateCartDisplay();
                    document.getElementById('customerSelect').value = '';
                    document.getElementById('discountAmount').value = '0';
                    document.getElementById('paymentMethod').value = 'cash';
                    document.getElementById('paymentReceived').value = '0';
                    document.getElementById('saleNotes').value = '';
                    
                    // Focus on product search
                    document.getElementById('productSearch').focus();
                    
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error processing sale: ' + error.message);
            }
        }

        // Utility function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Customer Management Functions
        let currentCustomer = null;

        async function searchCustomerByPhone() {
            const phoneInput = document.getElementById('customerPhone');
            const phone = phoneInput.value.trim();
            
            if (!phone) {
                alert('Please enter a mobile number');
                return;
            }
            
            // Basic phone validation
            const phoneRegex = /^[0-9+\-\s()]{10,}$/;
            if (!phoneRegex.test(phone)) {
                alert('Please enter a valid mobile number');
                return;
            }
            
            try {
                const response = await fetch(`/pos/api/customer/by-phone/${encodeURIComponent(phone)}/`);
                const result = await response.json();
                
                if (result.success) {
                    // Customer found - show details
                    displayCustomerDetails(result.customer);
                } else {
                    // Customer not found - show new customer form
                    showNewCustomerForm(phone);
                }
            } catch (error) {
                console.error('Error searching customer:', error);
                alert('Error searching customer. Please try again.');
            }
        }

        async function searchOrCreateCustomer() {
            const phoneInput = document.getElementById('customerPhone');
            const phone = phoneInput.value.trim();
            
            if (!phone) {
                alert('Please enter a mobile number');
                return;
            }
            
            try {
                const response = await fetch('/pos/api/customer/search-create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        phone: phone,
                        name: `Customer ${phone}` // Default name
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.exists) {
                        displayCustomerDetails(result.customer);
                        showToast('Customer found!', 'success');
                    } else {
                        displayCustomerDetails(result.customer);
                        showToast('New customer created!', 'success');
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error processing customer. Please try again.');
            }
        }

        function displayCustomerDetails(customer) {
            currentCustomer = customer;
            
            const customerDetails = document.getElementById('customerDetails');
            const customerInfo = document.getElementById('customerInfo');
            const selectedCustomerId = document.getElementById('selectedCustomerId');
            
            customerInfo.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Name:</strong> ${customer.name}
                    </div>
                    <div class="col-md-6">
                        <strong>Mobile:</strong> ${customer.phone}
                    </div>
                    ${customer.email ? `
                    <div class="col-md-6">
                        <strong>Email:</strong> ${customer.email}
                    </div>
                    ` : ''}
                    ${customer.address ? `
                    <div class="col-md-12 mt-1">
                        <strong>Address:</strong> ${customer.address}
                    </div>
                    ` : ''}
                </div>
            `;
            
            selectedCustomerId.value = customer.id;
            customerDetails.style.display = 'block';
            
            // Hide new customer form if visible
            document.getElementById('newCustomerForm').style.display = 'none';
        }

        function showNewCustomerForm(phone) {
            const newCustomerForm = document.getElementById('newCustomerForm');
            const newCustomerPhone = document.getElementById('newCustomerPhone');
            const newCustomerName = document.getElementById('newCustomerName');
            
            newCustomerPhone.value = phone;
            newCustomerName.value = `Customer ${phone}`;
            newCustomerName.focus();
            
            newCustomerForm.style.display = 'block';
            
            // Hide customer details if visible
            document.getElementById('customerDetails').style.display = 'none';
        }

        async function createNewCustomer() {
            const name = document.getElementById('newCustomerName').value.trim();
            const phone = document.getElementById('newCustomerPhone').value.trim();
            const email = document.getElementById('newCustomerEmail').value.trim();
            const address = document.getElementById('newCustomerAddress').value.trim();
            
            if (!name) {
                alert('Please enter customer name');
                return;
            }
            
            try {
                const response = await fetch('/pos/api/customer/search-create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        phone: phone,
                        name: name,
                        email: email,
                        address: address
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayCustomerDetails(result.customer);
                    document.getElementById('newCustomerForm').style.display = 'none';
                    showToast('Customer created successfully!', 'success');
                } else {
                    alert('Error creating customer: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating customer:', error);
                alert('Error creating customer. Please try again.');
            }
        }

        function cancelNewCustomer() {
            document.getElementById('newCustomerForm').style.display = 'none';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerPhone').focus();
        }

        function clearCustomer() {
            currentCustomer = null;
            document.getElementById('customerDetails').style.display = 'none';
            document.getElementById('selectedCustomerId').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerPhone').focus();
        }

        // Utility function to show toast messages
        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            // Add to container
            const container = document.getElementById('toastContainer') || createToastContainer();
            container.appendChild(toast);
            
            // Initialize and show toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Remove toast after hide
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }

        // Update the processSale function to use the selected customer
        async function processSale() {
            if (cart.length === 0) {
                alert('Please add items to cart');
                return;
            }

            const saleData = {
                customer_id: document.getElementById('selectedCustomerId').value || null,
                discount_amount: document.getElementById('discountAmount').value,
                payment_method: document.getElementById('paymentMethod').value,
                payment_received: document.getElementById('paymentReceived').value,
                notes: document.getElementById('saleNotes').value,
                items: cart.map(item => ({
                    product_id: item.product_id,
                    quantity: item.quantity,
                    unit_price: item.unit_price
                }))
            };

            try {
                const response = await fetch('/pos/api/create-sale/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(saleData)
                });

                const result = await response.json();
                
                if (result.success) {
                    // Open receipt in new window
                    const receiptWindow = window.open(`/pos/receipt/${result.sale_id}/`, '_blank');
                    
                    // Clear cart and reset form
                    cart = [];
                    updateCartDisplay();
                    clearCustomer(); // Clear customer selection
                    document.getElementById('discountAmount').value = '0';
                    document.getElementById('paymentMethod').value = 'cash';
                    document.getElementById('paymentReceived').value = '0';
                    document.getElementById('saleNotes').value = '';
                    
                    // Focus on product search
                    document.getElementById('productSearch').focus();
                    
                    showToast('Sale completed successfully!', 'success');
                    
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error processing sale: ' + error.message);
            }
        }

        // Add event listener for Enter key in phone input
        document.getElementById('customerPhone').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchCustomerByPhone();
            }
        });
    </script>
</body>
</html>