{% extends 'inventory/base.html' %}

{% block title %}{{ title }} - Door Shop{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">{{ title }}</h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.product.id_for_label }}" class="form-label">Product *</label>
                                {{ form.product }}
                                {% if form.product.errors %}
                                <div class="text-danger">{{ form.product.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.adjustment_type.id_for_label }}" class="form-label">Adjustment Type *</label>
                                {{ form.adjustment_type }}
                                {% if form.adjustment_type.errors %}
                                <div class="text-danger">{{ form.adjustment_type.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.quantity.id_for_label }}" class="form-label">Quantity *</label>
                                {{ form.quantity }}
                                {% if form.quantity.errors %}
                                <div class="text-danger">{{ form.quantity.errors }}</div>
                                {% endif %}
                                <div class="form-text">
                                    Enter the quantity for the adjustment. For stock out, this will be subtracted from current stock.
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.reason.id_for_label }}" class="form-label">Reason *</label>
                                {{ form.reason }}
                                {% if form.reason.errors %}
                                <div class="text-danger">{{ form.reason.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                        <div class="text-danger">{{ form.notes.errors }}</div>
                        {% endif %}
                        <div class="form-text">
                            Optional notes about this adjustment (e.g., damage, return, found stock, etc.)
                        </div>
                    </div>

                    <!-- Current Stock Info -->
                    <div class="card bg-light mb-3">
                        <div class="card-body">
                            <h6>Current Stock Information</h6>
                            <div id="stockInfo" class="text-muted">
                                Select a product to see current stock information.
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'stock_adjustment_list' %}" class="btn btn-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">Save Adjustment</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Adjustment Types Explanation -->
        <div class="card mt-4">
            <div class="card-body">
                <h6>üìù Understanding Adjustment Types</h6>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card bg-success text-white mb-3">
                            <div class="card-body">
                                <h6>Stock In</h6>
                                <p class="mb-0 small">Add stock to inventory (e.g., found items, returns, donations)</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-warning text-dark mb-3">
                            <div class="card-body">
                                <h6>Stock Out</h6>
                                <p class="mb-0 small">Remove stock from inventory (e.g., damage, theft, samples)</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info text-white mb-3">
                            <div class="card-body">
                                <h6>Adjustment</h6>
                                <p class="mb-0 small">Set stock to specific quantity (e.g., stock count correction)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const productSelect = document.getElementById('id_product');
        const stockInfo = document.getElementById('stockInfo');
        const quantityInput = document.getElementById('id_quantity');
        const adjustmentTypeSelect = document.getElementById('id_adjustment_type');
        
        // Product data cache
        const productData = {};
        
        // Fetch product data when product selection changes
        productSelect.addEventListener('change', function() {
            const productId = this.value;
            
            if (productId) {
                if (productData[productId]) {
                    updateStockInfo(productData[productId]);
                } else {
                    fetch(`/inventory/api/product/${productId}/stock-info/`)
                        .then(response => response.json())
                        .then(data => {
                            productData[productId] = data;
                            updateStockInfo(data);
                        })
                        .catch(error => {
                            stockInfo.innerHTML = '<span class="text-danger">Error loading product information</span>';
                        });
                }
            } else {
                stockInfo.innerHTML = 'Select a product to see current stock information.';
            }
        });
        
        function updateStockInfo(data) {
            if (data.track_stock) {
                stockInfo.innerHTML = `
                    <strong>Current Stock:</strong> ${data.current_stock} units<br>
                    <strong>Minimum Level:</strong> ${data.min_stock_level} units<br>
                    <strong>Status:</strong> <span class="badge ${data.current_stock <= data.min_stock_level ? 'bg-danger' : 'bg-success'}">
                        ${data.current_stock <= data.min_stock_level ? 'Low Stock' : 'In Stock'}
                    </span>
                `;
                
                // Set reasonable max for stock out
                if (adjustmentTypeSelect.value === 'out') {
                    quantityInput.max = data.current_stock;
                }
            } else {
                stockInfo.innerHTML = `
                    <strong>Stock Tracking:</strong> Disabled for this product<br>
                    <span class="text-muted">This product does not track stock levels.</span>
                `;
            }
        }
        
        // Update quantity constraints when adjustment type changes
        adjustmentTypeSelect.addEventListener('change', function() {
            const productId = productSelect.value;
            if (productId && productData[productId]) {
                if (this.value === 'out' && productData[productId].track_stock) {
                    quantityInput.max = productData[productId].current_stock;
                } else {
                    quantityInput.removeAttribute('max');
                }
            }
        });
        
        // Add Bootstrap classes to form fields
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            if (input.type !== 'checkbox' && input.type !== 'radio') {
                input.classList.add('form-control');
            }
        });
        
        // Add form-select class to select elements
        const selects = document.querySelectorAll('select');
        selects.forEach(select => {
            select.classList.add('form-select');
        });
    });
</script>
{% endblock %}